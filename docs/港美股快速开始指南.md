# Wondertrade 港美股快速开始指南

本指南将帮助您快速开始使用Wondertrade进行港美股交易。

## 目录

1. [环境准备](#环境准备)
2. [安装依赖](#安装依赖)
3. [配置富途OpenD](#配置富途opend)
4. [运行回测演示](#运行回测演示)
5. [实盘交易设置](#实盘交易设置)
6. [常见问题](#常见问题)

## 环境准备

### 系统要求

- Python 3.8+
- Windows 10/11 或 macOS 10.14+ 或 Linux
- 至少 4GB RAM
- 稳定的网络连接

### 富途账户要求

- 富途证券账户
- 港股或美股交易权限
- 富途牛牛客户端

## 安装依赖

### 1. 克隆项目

```bash
git clone https://github.com/wondertrader/wtpy.git
cd wtpy
```

### 2. 安装基础依赖

```bash
pip install -r requirements.txt
```

### 3. 安装港美股支持

```bash
python install_futu_support.py
```

这个脚本会自动安装：
- futu-api（富途OpenAPI）
- talib-binary（技术分析库）
- pyfolio（回测分析，可选）
- matplotlib（图表绘制，可选）

## 配置富途OpenD

### 1. 下载富途OpenD

访问 [富途开放平台](https://openapi.futunn.com/futu-api-doc/) 下载OpenD程序。

### 2. 启动OpenD

1. 运行富途牛牛客户端并登录
2. 启动OpenD程序
3. 确保OpenD在 `127.0.0.1:11111` 端口运行
4. 检查连接状态为"已连接"

### 3. 验证连接

```python
from futu import *

# 测试连接
quote_ctx = OpenQuoteContext(host='127.0.0.1', port=11111)
ret, data = quote_ctx.get_market_state([Market.HK, Market.US])
if ret == RET_OK:
    print("连接成功！")
    print(data)
else:
    print("连接失败：", data)
quote_ctx.close()
```

## 运行回测演示

### 腾讯控股DualThrust策略回测

```bash
cd demos/cta_hk_bt
python runBT.py
```

### 回测参数说明

- **股票代码**: HK.00700 (腾讯控股)
- **回测时间**: 2023年1月1日 - 2023年12月31日
- **策略**: DualThrust突破策略
- **K线周期**: 5分钟
- **初始资金**: 500,000 港币

### 查看回测结果

回测完成后，结果保存在 `./outputs_bt/dt_tencent/` 目录：

```
outputs_bt/dt_tencent/
├── funds.csv          # 资金曲线
├── trades.csv         # 交易记录
├── closes.csv         # 平仓记录
├── signals.csv        # 信号记录
└── summary.json       # 统计摘要
```

### 分析回测结果

使用内置分析工具：

```python
from wtpy.apps import WtBtAnalyst

analyst = WtBtAnalyst()
analyst.add_strategy('dt_tencent', folder='./outputs_bt/', 
                    init_capital=500000, rf=0.02, annual_trading_days=250)
analyst.run_new()
```

## 实盘交易设置

### 1. 配置交易密码

编辑 `demos/cta_hk_live/config.yaml`：

```yaml
futu:
  trade:
    unlock_password: "your_trade_password"  # 填入您的交易密码
    is_simulate: true                        # 模拟交易，设为false进行真实交易
```

### 2. 启动实盘交易

```bash
cd demos/cta_hk_live
python run.py
```

### 3. 监控交易状态

实盘交易启动后，可以通过以下方式监控：

- 查看控制台输出
- 检查日志文件 `./logs/live_trading.log`
- 使用富途牛牛客户端查看持仓和交易记录

### 4. 风险控制

实盘交易包含以下风控措施：

- 最大仓位限制：80%
- 单笔止损：5%
- 日内亏损限制：10%
- 自动撤单保护

## 策略自定义

### 修改策略参数

编辑 `demos/Strategies/DualThrustHK.py`：

```python
strategy = StraDualThrustHK(
    name='dt_tencent_live',
    code='HK.00700',        # 股票代码
    barCnt=50,              # K线数量
    period='m5',            # K线周期
    days=30,                # 历史数据天数
    k1=0.7,                 # 上轨系数
    k2=0.7,                 # 下轨系数
    max_pos=500,            # 最大持仓
    stop_loss=0.03          # 止损比例
)
```

### 添加新股票

1. 在 `demos/common/hk_us_contracts.json` 中添加合约信息
2. 在 `demos/common/hk_us_commodities.json` 中添加品种信息
3. 在 `demos/common/fees_hk.json` 中添加佣金配置

### 创建新策略

继承 `BaseCtaStrategy` 类：

```python
from wtpy import BaseCtaStrategy, CtaContext

class MyStrategy(BaseCtaStrategy):
    def __init__(self, name: str, code: str):
        BaseCtaStrategy.__init__(self, name)
        self.__code__ = code
    
    def on_init(self, context: CtaContext):
        # 策略初始化
        context.stra_prepare_bars(self.__code__, "m5", 50, isMain=True)
    
    def on_calculate(self, context: CtaContext):
        # 策略计算逻辑
        pass
```

## 常见问题

### Q1: 无法连接富途OpenD

**解决方案**:
1. 确保富途牛牛客户端已登录
2. 检查OpenD程序是否正常运行
3. 验证端口11111是否被占用
4. 检查防火墙设置

### Q2: 回测数据不足

**解决方案**:
1. 检查富途账户的数据权限
2. 确认股票代码格式正确（如：HK.00700）
3. 调整回测时间范围
4. 检查网络连接

### Q3: 实盘交易无法下单

**解决方案**:
1. 验证交易密码是否正确
2. 检查账户资金是否充足
3. 确认股票交易权限
4. 检查交易时间是否在开市时段

### Q4: 策略运行错误

**解决方案**:
1. 查看日志文件获取详细错误信息
2. 检查策略参数设置
3. 验证合约和品种配置文件
4. 确认Python依赖包版本兼容性

### Q5: 性能优化

**建议**:
1. 使用SSD硬盘存储数据
2. 增加内存配置
3. 优化策略计算逻辑
4. 合理设置K线数据缓存

## 技术支持

- **官方文档**: [Wondertrade文档](https://wondertrader.github.io/)
- **富途API文档**: [富途开放平台](https://openapi.futunn.com/futu-api-doc/)
- **GitHub Issues**: [提交问题](https://github.com/wondertrader/wtpy/issues)
- **QQ群**: 610730738

## 免责声明

本软件仅供学习和研究使用，不构成投资建议。使用本软件进行实盘交易的风险由用户自行承担。请在充分了解相关风险的前提下谨慎使用。

---

**祝您交易愉快！** 🚀